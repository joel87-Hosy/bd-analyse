<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FTECH - Dashboard Stable V10</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

    <style>
        :root { --moov-blue: #005bac; --moov-orange: #ff9900; }
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .navbar { background: var(--moov-blue); border-bottom: 4px solid var(--moov-orange); color: white; }
        .kpi-card { border-radius: 15px; border: none; color: white; padding: 25px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .bg-6h { background: linear-gradient(135deg, #1b5e20, #2e7d32); }
        .bg-12h { background: linear-gradient(135deg, #2e7d32, #43a047); }
        .bg-24h { background: linear-gradient(135deg, #f9a825, #fbc02d); }
        .bg-over { background: linear-gradient(135deg, #b71c1c, #d32f2f); }
        .chart-card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 25px; min-height: 400px; }
        .main-table-container { background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); overflow: hidden; }
        .table thead th { background: #f1f3f5; color: #495057; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; border: none; }
        .incident-details { display: none; background: #f1f8ff; transition: all 0.3s ease; }
        .sheet-box { border-radius: 10px; border: 1px solid #dee2e6; height: 100%; transition: 0.2s; }
        .sheet-box:hover { border-color: var(--moov-orange); background: #fff; }
    </style>
</head>
<body>

<nav class="navbar shadow-sm sticky-top">
    <div class="container-fluid px-4">
        <span class="navbar-brand fw-bold"><i class="fas fa-chart-line me-2"></i> PERFORMANCE FTECH V10 (STABLE)</span>
        <div id="actionBtns" style="display:none">
            <button class="btn btn-light btn-sm fw-bold me-2" onclick="sendToGmail()"><i class="fas fa-envelope text-primary"></i> Gmail</button>
            <button class="btn btn-success btn-sm fw-bold me-2" onclick="exportExcel()"><i class="fas fa-file-excel"></i> Excel</button>
            <button class="btn btn-danger btn-sm fw-bold" onclick="generatePPT()"><i class="fas fa-file-powerpoint"></i> Export PPTX</button>
        </div>
    </div>
</nav>

<div class="container-fluid p-4">
    <div id="dropZone" class="card border-2 border-dashed p-5 text-center mb-4 bg-white shadow-sm" style="cursor:pointer; border: 3px dashed #cbd5e0 !important;" onclick="document.getElementById('fileIn').click()">
        <input type="file" id="fileIn" hidden onchange="handleFile(event)">
        <i class="fas fa-file-import fa-4x text-primary mb-3"></i>
        <h4 class="fw-bold">Glissez ou cliquez pour analyser le fichier</h4>
        <p class="text-muted">Analyse corrective MTTR CRM & Métier | Classement Volume | Fiche Signalétique</p>
    </div>

    <div id="dashContent" style="display:none">
        
        <div id="clientSheet" class="card shadow mb-4 border-0" style="display:none; border-top: 5px solid var(--moov-orange) !important;">
            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                <h5 class="m-0 fw-bold text-primary"><i class="fas fa-user-tag me-2"></i>FICHE CLIENT : <span id="shClient" class="text-dark"></span></h5>
                <button class="btn-close" onclick="document.getElementById('clientSheet').style.display='none'"></button>
            </div>
            <div class="card-body bg-light">
                <div class="row g-3">
                    <div class="col-md-3"><div class="p-3 bg-white sheet-box"><b>Ligne:</b> <span id="shLigne"></span><br><b>GPS:</b> <span id="shGPS" class="small"></span></div></div>
                    <div class="col-md-3"><div class="p-3 bg-white sheet-box"><b>Localisation:</b> <span id="shLoc"></span><br><b>SRO:</b> <span id="shSRO"></span></div></div>
                    <div class="col-md-3"><div class="p-3 bg-white sheet-box"><b>Contact:</b> <span id="shContact"></span><br><b>Équipe:</b> <span id="shTech"></span></div></div>
                    <div class="col-md-3"><div class="p-3 bg-white sheet-box text-center">
                        <span class="badge bg-primary mb-1">MTTR Métier: <span id="shM1"></span></span><br>
                        <span class="badge bg-secondary">MTTR CRM: <span id="shM2"></span></span>
                    </div></div>
                </div>
            </div>
        </div>

        <div class="row g-3 mb-4 text-white">
            <div class="col-md-3"><div class="kpi-card bg-6h"><h6>SLA < 6H</h6><h1 id="k6" class="fw-bold">0</h1></div></div>
            <div class="col-md-3"><div class="kpi-card bg-12h"><h6>6H - 12H</h6><h1 id="k12" class="fw-bold">0</h1></div></div>
            <div class="col-md-3"><div class="kpi-card bg-24h"><h6>12H - 24H</h6><h1 id="k24" class="fw-bold">0</h1></div></div>
            <div class="col-md-3"><div class="kpi-card bg-over"><h6>HORS DÉLAI</h6><h1 id="kOver" class="fw-bold">0</h1></div></div>
        </div>

        <div class="row">
            <div class="col-md-8">
                <div class="chart-card">
                    <h6 class="fw-bold"><i class="fas fa-users text-primary me-2"></i>Performance Techniciens (Volume de résolution)</h6>
                    <div style="height: 340px;"><canvas id="chartVol"></canvas></div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="chart-card text-center">
                    <h6 class="fw-bold">Qualité de Service (SLA %)</h6>
                    <div style="height: 340px;"><canvas id="chartPie"></canvas></div>
                </div>
            </div>
        </div>

        <div class="main-table-container">
            <div class="p-3 border-bottom d-flex justify-content-between align-items-center bg-white">
                <span class="fw-bold text-dark"><i class="fas fa-list me-2"></i>LISTE DES INCIDENTS</span>
                <input type="text" id="searchBox" class="form-control form-control-sm w-25 border-primary" placeholder="Filtrer ticket, client, tech..." onkeyup="filter()">
            </div>
            <div class="table-responsive" style="max-height: 550px;">
                <table class="table table-hover align-middle" id="mainTable">
                    <thead>
                        <tr>
                            <th></th><th>Ticket</th><th>Client</th><th>Équipe</th><th>MTTR Métier</th><th>MTTR CRM</th><th>SLA</th><th class="text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody id="tBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
let processed = [];
let charts = {};

function handleFile(e) {
    const f = e.target.files[0];
    const r = new FileReader();
    r.onload = (evt) => {
        const wb = XLSX.read(evt.target.result, {type:'binary'});
        const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        process(data);
    };
    r.readAsBinaryString(f);
}

function process(rows) {
    let stats = { k6:0, k12:0, k24:0, kOver:0, techs:{} };
    processed = [];

    rows.forEach(r => {
        // Nettoyage des dates pour éviter le "tirage"
        const dSig = moment(r["Date de signalisation"]);
        const dRes = moment(r["Date et heure de résolution"]);
        const dCrm = moment(r["Date de création sur CRM"]);
        const dRel = moment(r["Date et heure de relève dérangement"]); // Optionnel selon usage

        if(dSig.isValid() && dRes.isValid()) {
            // MTTR Métier (Délai de résolution - Signalisation)
            const hMetier = dRes.diff(dSig, 'hours', true);
            // MTTR CRM (Délai de résolution - Création CRM)
            const hCrm = dCrm.isValid() ? dRes.diff(dCrm, 'hours', true) : 0;

            let sla = hMetier <= 6 ? "<6h" : hMetier <= 12 ? "6-12h" : hMetier <= 24 ? "12-24h" : ">24h";
            if(hMetier <= 6) stats.k6++; else if(hMetier <= 12) stats.k12++; else if(hMetier <= 24) stats.k24++; else stats.kOver++;

            const tName = r["Equipes"] || "NON ASSIGNÉ";
            stats.techs[tName] = (stats.techs[tName] || 0) + 1;

            processed.push({
                id: r["Numéro de Requête"], client: r["Nom du client MBS"], ligne: r["Ligne fixe"],
                tech: tName, hM: hMetier.toFixed(1), hC: hCrm.toFixed(1), sla: sla, details: r
            });
        }
    });

    updateDashboard(stats);
}

function updateDashboard(s) {
    document.getElementById('dashContent').style.display = 'block';
    document.getElementById('actionBtns').style.display = 'block';
    document.getElementById('k6').innerText = s.k6;
    document.getElementById('k12').innerText = s.k12;
    document.getElementById('k24').innerText = s.k24;
    document.getElementById('kOver').innerText = s.kOver;

    const b = document.getElementById('tBody');
    b.innerHTML = processed.map((d, i) => `
        <tr onclick="toggle(${i})" style="cursor:pointer">
            <td><i class="fas fa-plus-circle text-muted" id="icon-${i}"></i></td>
            <td><small class="fw-bold">${d.id}</small></td>
            <td><small>${d.client}</small></td>
            <td>${d.tech}</td>
            <td class="text-primary fw-bold">${d.hM}h</td>
            <td class="text-muted">${d.hC}h</td>
            <td><span class="badge ${getSlaCol(d.sla)}">${d.sla}</span></td>
            <td class="text-center"><button class="btn btn-sm btn-primary shadow-sm" onclick="showFiche(${i}); event.stopPropagation();"><i class="fas fa-eye"></i></button></td>
        </tr>
        <tr id="det-${i}" class="incident-details"><td colspan="8">
            <div class="p-3 small row bg-white border rounded m-2 shadow-sm">
                <div class="col-md-4"><b>Cause:</b> ${d.details["Cause du dérangement"]}<br><b>Action:</b> ${d.details["Action de Résolution"]}</div>
                <div class="col-md-4"><b>SRO:</b> ${d.details["SRO CLIENT"]}<br><b>Commentaire:</b> ${d.details["Commentaire_cause"] || 'N/A'}</div>
                <div class="col-md-4 text-end text-muted">Signalé: ${d.details["Date de signalisation"]}<br>Résolu: ${d.details["Date et heure de résolution"]}</div>
            </div>
        </td></tr>`).join('');

    render(s);
}

function showFiche(i) {
    const d = processed[i];
    const det = d.details;
    document.getElementById('clientSheet').style.display = 'block';
    document.getElementById('shClient').innerText = d.client;
    document.getElementById('shLigne').innerText = d.ligne;
    document.getElementById('shGPS').innerText = det["GPS"] || "Coordonnées absentes";
    document.getElementById('shLoc').innerText = det["LOCALISATION"];
    document.getElementById('shSRO').innerText = det["SRO CLIENT"] + " / " + det["PCO CLIENT"];
    document.getElementById('shContact').innerText = det["CONTACT CLIENT 1"];
    document.getElementById('shTech').innerText = d.tech;
    document.getElementById('shM1').innerText = d.hM + " h";
    document.getElementById('shM2').innerText = d.hC + " h";
    window.scrollTo({top: 0, behavior: 'smooth'});
}

function render(s) {
    if(charts.v) charts.v.destroy();
    const sorted = Object.entries(s.techs).sort((a,b)=>b[1]-a[1]);
    charts.v = new Chart(document.getElementById('chartVol'), {
        type: 'bar',
        data: { labels: sorted.map(x=>x[0]), datasets: [{ label: 'Tickets Résolus', data: sorted.map(x=>x[1]), backgroundColor: '#005bac', borderRadius: 8 }] },
        options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
    });

    if(charts.p) charts.p.destroy();
    charts.p = new Chart(document.getElementById('chartPie'), {
        type: 'doughnut',
        data: { labels: ['<6h','6-12h','12-24h','>24h'], datasets: [{ data: [s.k6, s.k12, s.k24, s.kOver], backgroundColor: ['#1b5e20','#43a047','#fbc02d','#d32f2f'] }] },
        options: { maintainAspectRatio: false, cutout: '70%' }
    });
}

function toggle(i) {
    const r = document.getElementById(`det-${i}`);
    const ic = document.getElementById(`icon-${i}`);
    const vis = r.style.display === 'table-row';
    r.style.display = vis ? 'none' : 'table-row';
    ic.className = vis ? 'fas fa-plus-circle text-muted' : 'fas fa-minus-circle text-danger';
}

function getSlaCol(s) {
    return s==="<6h" ? "bg-6h" : s==="6-12h" ? "bg-12h" : s==="12-24h" ? "bg-24h" : "bg-over";
}

function filter() {
    let q = document.getElementById('searchBox').value.toLowerCase();
    processed.forEach((d, i) => {
        let match = d.id.toLowerCase().includes(q) || d.client.toLowerCase().includes(q) || d.tech.toLowerCase().includes(q);
        document.querySelectorAll(`#mainTable tbody tr`)[i*2].style.display = match ? 'table-row' : 'none';
        document.getElementById(`det-${i}`).style.display = 'none';
    });
}

function generatePPT() {
    let pres = new PptxGenJS();
    let s = pres.addSlide();
    s.addText("RAPPORT PERFORMANCE FTECH V10", { x:0.5, y:0.5, fontSize:22, bold:true, color:'005bac' });
    s.addText(`Analyse sur ${processed.length} incidents.`, { x:0.5, y:1.2, fontSize:14 });
    let rows = [['Technicien', 'Volume Résolu'], ...Object.entries(processed.reduce((acc,curr)=>{acc[curr.tech]=(acc[curr.tech]||0)+1; return acc;},{})).sort((a,b)=>b[1]-a[1]).slice(0,10)];
    s.addTable(rows, { x:0.5, y:1.8, w:9, border:{pt:1, color:'CCCCCC'} });
    pres.writeFile({ fileName: "Performance_FTECH.pptx" });
}

function exportExcel() {
    const ws = XLSX.utils.json_to_sheet(processed.map(({details, ...rest}) => rest));
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Détails");
    XLSX.writeFile(wb, "Analyse_Performance_V10.xlsx");
}

function sendToGmail() {
    const sub = encodeURIComponent("Rapport Performance Maintenance");
    const body = encodeURIComponent(`Analyse Terminée.\nTotal Incidents: ${processed.length}\nSLA Moyen < 24h: ${(((processed.length - parseInt(document.getElementById('kOver').innerText))/processed.length)*100).toFixed(1)}%`);
    window.open(`https://mail.google.com/mail/?view=cm&fs=1&su=${sub}&body=${body}`, '_blank');
}
</script>
</body>
</html>